

### 1) Summary
- 위험도: High
- 최우선 액션
  - 서비스/익명 키 하드코딩 제거 및 REST 직접 호출 제거(환경변수/서버 전용으로 통일)
  - 스키마↔타입 동기화(chat_messages/chat_participants, sample_request_items 오타 수정)
  - RLS/Storage 보강(confirmation_requests 정책 신설, private 버킷 서명 URL 전환)

### 2) Blocking Issues
- 하드코딩된 Supabase URL/키(클라이언트 번들/레포에 노출)
  - 익명키/URL 하드코딩
```4:20:nextjs_flexy/src/lib/supabase/client-simple.ts
export function createSimpleClient() {
  const supabaseUrl = 'https://fzpyfzpmwyvqumvftfbr.supabase.co'
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```
  - REST 직접 호출도 하드코딩
```1:20:nextjs_flexy/src/lib/utils/supabase-fetch.ts
const supabaseUrl = 'https://fzpyfzpmwyvqumvftfbr.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
```
  - 서비스 롤 키 fallback 하드코딩(치명)
```5:12:nextjs_flexy/scripts/import-hs-codes.js
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...service_role...'
```

- 스키마↔타입 불일치(chat_messages, chat_participants)
  - 실제 스키마: reservation_number 존재, order_id 없음
```1004:1010:supabase/production-dump/full_schema.sql
"reservation_number" character varying(255) NOT NULL,
"service_type" character varying(50),
```
  - 타입 정의: order_id만 존재, reservation_number 누락
```296:306:nextjs_flexy/src/lib/types/database.ts
chat_messages: {
  Row: {
    ...
    order_id: string
```

- 존재하지 않는 테이블 참조(sample_request_items)
```99:104:nextjs_flexy/src/app/dashboard/orders/sampling/[reservationNumber]/page.tsx
const { data: sampleData } = await supabase
  .from('sample_request_items')
  .select('*')
  .eq('reservation_number', reservationNumber)
```
  - 스키마 덤프에 해당 테이블 없음(검색 결과 0)

- Storage 버킷 private인데 public URL 사용
  - 버킷을 private으로 설정
```21:29:nextjs_flexy/src/scripts/update-storage-bucket.ts
await supabase.storage.updateBucket('application-files', {
  public: false,
```
  - 업로드 후 getPublicUrl 사용(접근 불가/403 위험)
```115:118:nextjs_flexy/src/app/api/files/upload/route.ts
const { data: { publicUrl } } = supabase.storage
  .from(bucket)
  .getPublicUrl(fileName);
```

- RLS 없는 테이블 사용(정책 미설정)
  - confirmation_requests: RLS 활성화됨, 정책 부재(읽기/수정 불가)
```3695:3698:supabase/production-dump/full_schema.sql
ALTER TABLE "public"."confirmation_requests" ENABLE ROW LEVEL SECURITY;
```
  - 코드에서 읽고/갱신 시도
```141:173:nextjs_flexy/src/app/dashboard/orders/factory-contact/[reservationNumber]/page.tsx
const { data: confirmData } = await supabase
  .from('confirmation_requests')
  .select('*')
...
await supabase.from('confirmation_requests').update({ ... })
```

### 3) 스키마↔프론트 맵
- 표: table.col | 타입 | Null/Default | 참조 파일:라인[] | 사용빈도 | 상태
- chat_messages.reservation_number | varchar | NOT NULL | [ChatPanel.tsx:61-63, useChat.tsx:169-173] | 높음 | 오류(타입 누락)
- chat_messages.order_id | (없음) | - | [database.ts:307] | - | 오류(타입 과잉)
- chat_participants.reservation_number | varchar | NOT NULL | [useChat.tsx 채널 필터] | 중 | 오류(타입 누락, types에는 order_id)
- uploaded_files.file_path | text | NOT NULL | [FileManager.tsx:167-178, upload/route.ts:124-131] | 중 | OK
- uploaded_files.file_url | text | NULL | [upload/route.ts:121-131] | 중 | 주의(공개 URL 저장)
- market_research_requests.user_id | uuid | NOT NULL | [MyOrderStatsCards.tsx:54-63] | 높음 | OK
- inspection_applications.reservation_number | varchar | NOT NULL | [여러 페이지 eq] | 높음 | OK
- confirmation_requests.reservation_number | varchar | NOT NULL | [factory-contact 상세] | 중 | 정책 없음
- hs_codes.* | ... | RLS SELECT true | [Edge Functions 다수] | 서버 | OK(공개 읽기)
- sample_request_items.* | - | - | [sampling page:100-104] | - | 오류(테이블 없음)

[Assumption:] types 파일은 과거 스키마 기반으로 생성되어 chat_*의 주요 컬럼이 어긋났습니다.

### 4) RLS Matrix
- 표: table | op | role | USING | CHECK | 위험/중복 | 수정 제안
- chat_messages | SELECT | user, staff | 다양한 policy(own, by reservation, team) | - | OK | 유지
- chat_messages | INSERT | authenticated | auth.uid()=sender_id | with check 존재 | OK | 유지
- uploaded_files | SELECT | authenticated | own or same reservation | - | OK | 유지
- uploaded_files | INSERT/UPDATE | authenticated | uid=uploaded_by | with check 동일 | OK | 유지
- market_research_requests | SELECT/UPDATE | user | uid=user_id AND status in ... | - | 중복 다수 | UPDATE에 WITH CHECK 대칭 명시 권장
- bulk_orders, inspection_applications | ALL(미지정) | korean_team/admin | USING exists(user_profiles) | (없음) | 모호 | FOR SELECT/UPDATE 분리 + WITH CHECK 대칭 추가 권장
- faqs/notices | SELECT | public | is_visible=true | - | OK | 유지
- confirmation_requests | ALL | - | - | - | High(정책 부재) | SELECT/UPDATE 정책 신설(소유자·스태프)

근거(예):
```3490:3498:supabase/production-dump/full_schema.sql
CREATE POLICY "Korean team full access" ON "public"."bulk_orders" USING ((EXISTS (
  SELECT 1 FROM "public"."user_profiles"
  WHERE ("user_profiles"."user_id" = "auth"."uid"())
    AND ("user_profiles"."role"::text = ANY (ARRAY['korean_team','admin']::text[]))
)));
```

### 5) SDK/SSR 진단(체크리스트)
- 항목 | 상태 | 근거 | 수정안
- v2 일관성 | 부분 위반 | REST 직접 fetch, client-simple 하드코딩 | REST 제거, 전부 @supabase/ssr+SDK로 통일
- 서비스키 서버 한정 | 위험 | import-hs-codes.js fallback SRK | 파일 제거/비공개, ENV 필수
- 브라우저 키 하드코딩 | 위험 | client-simple.ts, supabase-fetch.ts | 삭제
- SSR 경계 | 대체로 OK | middleware/server 클라 구분 | 유지
- persistSession 설정 | 적절 | client-simple만 false | client-simple 삭제
- Realtime 구독 해제 | OK | useChat.tsx cleanup unsubscribe | 유지
```189:194:nextjs_flexy/src/app/dashboard/orders/[reservationNumber]/hooks/useChat.tsx
return () => {
  if (channelRef.current) {
    channelRef.current.unsubscribe();
  }
}
```

### 6) 퍼포먼스/인덱스 제안
- 쿼리: MyOrderStatsCards 각 서비스별 count by user_id,status → 복합 인덱스 제안
  - 제안: market_research_requests(user_id, status), factory_contact_requests(user_id, status), inspection_applications(user_id, status)
- chat_messages 최근 5개: reservation_number + created_at desc → 이미 idx 존재(reservation_number, created_at). 유지
- uploaded_files 목록: reservation_number eq + created_at desc → reservation_number, created_at 각각 인덱스 존재. 필요시 복합 인덱스 추가 고려.

### 7) 삭제/정리 대상
- 대상 | 이유 | 영향도 | 대안
- `nextjs_flexy/src/lib/supabase/client-simple.ts` | 키 하드코딩 | High | 삭제
- `nextjs_flexy/src/lib/utils/supabase-fetch.ts` | REST 직접, 키 하드코딩 | High | SDK로 대체
- `nextjs_flexy/scripts/import-hs-codes.js` | SRK 하드코딩 | High | ENV 필수 or 삭제
- `supabase/functions/hs-code-smart-search/index.backup.ts` | 백업본 | Low | 삭제
- `test-upload.js`, `nextjs_flexy/test-supabase-edge.js` | 데모/테스트 | Low | 비공개로 이동/삭제

### 8) 제안 마이그레이션 SQL + 코드 edits

- SQL: confirmation_requests RLS 정책 신설(+ 인덱스)
```sql
-- 1) 소유자(해당 주문의 user) 조회/갱신 허용
CREATE POLICY "users_view_own_confirmation_requests"
ON public.confirmation_requests FOR SELECT
USING (
  reservation_number IN (
    SELECT reservation_number FROM public.market_research_requests WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.inspection_applications WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.factory_contact_requests WHERE user_id = auth.uid()
  )
);

CREATE POLICY "users_update_own_pending_confirmation_requests"
ON public.confirmation_requests FOR UPDATE
USING (
  reservation_number IN (
    SELECT reservation_number FROM public.market_research_requests WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.inspection_applications WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.factory_contact_requests WHERE user_id = auth.uid()
  ) AND status = 'pending'
)
WITH CHECK (
  reservation_number IN (
    SELECT reservation_number FROM public.market_research_requests WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.inspection_applications WHERE user_id = auth.uid()
    UNION SELECT reservation_number FROM public.factory_contact_requests WHERE user_id = auth.uid()
  ) AND status = 'pending'
);

-- 2) 스태프 전권(조회/갱신)
CREATE POLICY "staff_all_access_confirmation_requests"
ON public.confirmation_requests
USING (
  EXISTS (SELECT 1 FROM public.user_profiles
          WHERE user_profiles.user_id = auth.uid()
            AND user_profiles.role IN ('korean_team','admin','chinese_staff'))
)
WITH CHECK (
  EXISTS (SELECT 1 FROM public.user_profiles
          WHERE user_profiles.user_id = auth.uid()
            AND user_profiles.role IN ('korean_team','admin','chinese_staff'))
);

-- 3) 보조 인덱스
CREATE INDEX IF NOT EXISTS idx_confirmation_requests_res_no ON public.confirmation_requests(reservation_number);
CREATE INDEX IF NOT EXISTS idx_confirmation_requests_status ON public.confirmation_requests(status);
```

- SQL: 팀 전권 정책을 UPDATE에도 대칭(예: bulk_orders/inspection_applications)
```sql
-- 예: bulk_orders에 UPDATE 대칭 추가
CREATE POLICY "korean_team_update_bulk_orders"
ON public.bulk_orders FOR UPDATE
USING (
  EXISTS (SELECT 1 FROM public.user_profiles
    WHERE user_profiles.user_id = auth.uid()
      AND user_profiles.role IN ('korean_team','admin'))
)
WITH CHECK (
  EXISTS (SELECT 1 FROM public.user_profiles
    WHERE user_profiles.user_id = auth.uid()
      AND user_profiles.role IN ('korean_team','admin'))
);
```

- SQL: 카운트용 복합 인덱스
```sql
CREATE INDEX IF NOT EXISTS idx_mr_user_status ON public.market_research_requests(user_id, status);
CREATE INDEX IF NOT EXISTS idx_fc_user_status ON public.factory_contact_requests(user_id, status);
CREATE INDEX IF NOT EXISTS idx_in_user_status ON public.inspection_applications(user_id, status);
```

- SQL(옵션): sample_request_items 대체 뷰(빠른 복구)
```sql
CREATE OR REPLACE VIEW public.sample_request_items AS
SELECT * FROM public.market_research_samples;
```

- 코드 edits: 하드코딩/REST 제거, 타입 수정, Storage 서명 URL

diff: ChatPanel 불필요 import 제거
```diff
--- a/nextjs_flexy/src/app/dashboard/orders/_components/ChatPanel.tsx
+++ b/nextjs_flexy/src/app/dashboard/orders/_components/ChatPanel.tsx
@@ -19,8 +19,6 @@
 } from '@mui/icons-material';
 import { useUser } from '@/lib/context/GlobalContext';
-import { fetchChatMessages as fetchMessages, insertChatMessage } from '@/lib/utils/supabase-fetch';
-import { createSimpleClient } from '@/lib/supabase/client-simple';
```

diff: sampling 페이지 테이블명 수정
```diff
--- a/nextjs_flexy/src/app/dashboard/orders/sampling/[reservationNumber]/page.tsx
+++ b/nextjs_flexy/src/app/dashboard/orders/sampling/[reservationNumber]/page.tsx
@@ -99,7 +99,7 @@
-        const { data: sampleData, error: sampleError } = await supabase
-          .from('sample_request_items')
+        const { data: sampleData, error: sampleError } = await supabase
+          .from('market_research_samples')
           .select('*')
           .eq('reservation_number', reservationNumber)
           .maybeSingle();
```

diff: 업로드 API 서명 URL로 교체(private 버킷 호환)
```diff
--- a/nextjs_flexy/src/app/api/files/upload/route.ts
+++ b/nextjs_flexy/src/app/api/files/upload/route.ts
@@ -113,12 +113,17 @@
-    // 공개 URL 가져오기
-    const { data: { publicUrl } } = supabase.storage
-      .from(bucket)
-      .getPublicUrl(fileName);
+    // 서명 URL 생성 (예: 1시간)
+    const { data: signed, error: signErr } = await supabase.storage
+      .from(bucket)
+      .createSignedUrl(fileName, 3600);
+    if (signErr) throw signErr;
+    const publicUrl = signed.signedUrl;
```

diff: 하드코딩 파일 제거(레포 정리)
```diff
--- a/nextjs_flexy/src/lib/supabase/client-simple.ts
+++ /dev/null
@@ -1,20 +0,0 @@
-... (파일 전체 삭제)
```
```diff
--- a/nextjs_flexy/src/lib/utils/supabase-fetch.ts
+++ /dev/null
@@ -1,84 +0,0 @@
-... (파일 전체 삭제)
```
```diff
--- a/nextjs_flexy/scripts/import-hs-codes.js
+++ b/nextjs_flexy/scripts/import-hs-codes.js
@@ -4,7 +4,7 @@
-const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
+const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY
+if (!supabaseKey) { throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY') }
```

- 타입 재생성(명령)
```bash
npx supabase gen types typescript --project-id $PROJECT_REF > nextjs_flexy/src/lib/types/database.ts
```

### 9) 후속 안전 점검 체크리스트
- DB 백업/DR
  - supabase db dump, 스냅샷 보관
- 마이그레이션 dry-run
  - supabase db lint, deploy --dry-run
- 롤백 플랜
  - 신규 정책/인덱스 DROP SQL 준비
- Secrets 점검
  - Vercel 환경변수만 사용, 레포에서 키 제거(BFG 기록 포함)
- Storage
  - private 버킷 접근 테스트(서명 URL로 다운로드/미리보기)
- 타입/빌드
  - types 재생성 후 TS 빌드, 런타임 smoke test
- 권한 회귀 테스트
  - 고객/스태프 각 역할로 주요 화면 접근/쓰기 검증

검증 체크리스트(요약):
- [ ] 클라이언트 번들에 서비스/DB 키 미포함
- [ ] v2 API만 사용, REST 직접 호출 제거
- [ ] RLS USING/CHECK 대칭, TRUE 남발 없음(참조 데이터 제외)
- [ ] Storage private, 서명 URL 사용 및 만료 설정
- [ ] select('*') 제거·컬럼 한정, keyset 페이지네이션
- [ ] 인덱스 커버리지 확보
- [ ] SECURITY DEFINER 최소화(필요 함수에만)
- [ ] 미사용/위험 요소 삭제

요약
- 하드코딩된 키와 REST 직접 호출, 스키마/타입 불일치, RLS/Storage 정책 미비가 핵심 리스크.
- 즉시 수정안(하드코딩 제거·서명 URL 전환·RLS 보강·타입 재생성·테이블명 수정)과 관련 SQL/코드 edits를 제시.
- count/목록 쿼리에 대한 인덱스 보강으로 성능 개선을 제안.