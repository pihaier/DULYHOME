📬 대시보드 메시지 시스템 구현 계획

  1. 시스템 개요

  1.1 목적

  - 모든 서비스(시장조사, 공장컨택, 검품감사, 1688 상품문의)의 채팅을 통합 관리
  - 안읽은 메시지 실시간 알림
  - 중앙화된 메시지 허브 제공

  1.2 사용 테이블

  - 기존 테이블 활용: chat_messages (변경 없음)
  - 추가 테이블 불필요: 모든 정보가 이미 존재

  2. 네비게이션 메뉴 구조

  2.1 MenuItems.ts 수정

  {
    navlabel: true,
    subheader: '💬 메시지',
  },
  {
    id: uniqueId(),
    title: '전체 메시지',
    icon: IconMessage2,
    href: '/dashboard/messages',
    chip: '3', // 안읽은 메시지 수 (동적)
    chipColor: 'error',
  }

  2.2 메뉴 위치

  📊 주문 조회
    └─ 시장조사 조회
    └─ 공장컨택 조회
    └─ 검품감사 조회

  💬 메시지  ← 새로 추가
    └─ 전체 메시지 (3)

  ⚡ 빠른 액세스
    └─ 내 프로필

  3. 페이지 구조

  3.1 메시지 목록 페이지

  경로: /dashboard/messages/page.tsx

  주요 기능:

  - 채팅방 목록 (reservation_number로 그룹핑)
  - 각 채팅방별 정보 표시:
    - 서비스 타입 아이콘
    - 예약번호
    - 상대방 이름
    - 최근 메시지 미리보기
    - 안읽은 메시지 수 Badge
    - 최근 메시지 시간
  - 정렬: 최신 메시지 순
  - 필터: 서비스 타입별, 읽음/안읽음

  UI 레이아웃:

  ┌─────────────────────────────────────────┐
  │ 💬 메시지 센터                           │
  │                                         │
  │ [전체] [시장조사] [공장컨택] [검품] [1688]│
  │                                         │
  │ ┌─────────────────────────────────────┐ │
  │ │ 🏭 FC-20241215-001234        (2) 🔴│ │
  │ │ 김철수 (ABC공장)                    │ │
  │ │ "네, 샘플 준비되었습니다..."        │ │
  │ │                         5분 전      │ │
  │ └─────────────────────────────────────┘ │
  │                                         │
  │ ┌─────────────────────────────────────┐ │
  │ │ 🛍️ PROD-123456789            (1) 🔴│ │
  │ │ 1688 상품 문의                      │ │
  │ │ "이 제품 MOQ가 어떻게..."           │ │
  │ │                         1시간 전    │ │
  │ └─────────────────────────────────────┘ │
  │                                         │
  │ ┌─────────────────────────────────────┐ │
  │ │ 📋 DL-20241214-005678              │ │
  │ │ 이영희 (검품감사)                   │ │
  │ │ "검품 완료되었습니다"               │ │
  │ │                         어제        │ │
  │ └─────────────────────────────────────┘ │
  └─────────────────────────────────────────┘

  3.2 메시지 상세 페이지

  경로: /dashboard/messages/[reservationNumber]/page.tsx

  주요 기능:

  - 기존 ChatPanel 컴포넌트 재사용
  - 페이지 진입 시 자동 읽음 처리
  - 실시간 메시지 송수신
  - 파일 업로드
  - 번역 기능 (GPT-5-mini)

  4. 데이터 쿼리 전략

  4.1 채팅방 목록 가져오기

  -- 각 예약번호별 최신 메시지와 안읽은 수
  WITH latest_messages AS (
    SELECT DISTINCT ON (reservation_number)
      reservation_number,
      service_type,
      sender_name,
      original_message,
      created_at
    FROM chat_messages
    ORDER BY reservation_number, created_at DESC
  ),
  unread_counts AS (
    SELECT
      reservation_number,
      COUNT(*) as unread_count
    FROM chat_messages
    WHERE is_read = false
      AND sender_id != $1  -- 내가 보낸 메시지 제외
    GROUP BY reservation_number
  )
  SELECT
    lm.*,
    COALESCE(uc.unread_count, 0) as unread_count
  FROM latest_messages lm
  LEFT JOIN unread_counts uc ON lm.reservation_number = uc.reservation_number
  ORDER BY lm.created_at DESC;

  4.2 전체 안읽은 메시지 수

  SELECT COUNT(*) as total_unread
  FROM chat_messages
  WHERE is_read = false
    AND sender_id != $1;  -- 내가 보낸 메시지 제외

  4.3 메시지 읽음 처리

  UPDATE chat_messages
  SET is_read = true
  WHERE reservation_number = $1
    AND sender_id != $2  -- 내가 보낸 메시지 제외
    AND is_read = false;

  5. 실시간 기능 구현

  5.1 Realtime 구독 설정

  // 전체 안읽은 메시지 수 구독
  const unreadChannel = supabase
    .channel('unread_messages')
    .on('postgres_changes', {
      event: '*',
      schema: 'public',
      table: 'chat_messages',
      filter: `is_read=eq.false`
    }, handleUnreadUpdate)
    .subscribe();

  // 특정 채팅방 구독
  const chatChannel = supabase
    .channel(`chat_${reservationNumber}`)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'chat_messages',
      filter: `reservation_number=eq.${reservationNumber}`
    }, handleNewMessage)
    .subscribe();

  5.2 Context Provider 생성

  // MessageContext.tsx
  export const MessageProvider = ({ children }) => {
    const [unreadCount, setUnreadCount] = useState(0);
    const [chatRooms, setChatRooms] = useState([]);

    // 실시간 업데이트 로직
    // ...

    return (
      <MessageContext.Provider value={{ unreadCount, chatRooms }}>
        {children}
      </MessageContext.Provider>
    );
  };

  6. 컴포넌트 구조

  6.1 컴포넌트 계층

  /dashboard/messages/
  ├── page.tsx                    # 메시지 목록 페이지
  ├── [reservationNumber]/
  │   └── page.tsx                # 채팅 상세 페이지
  └── _components/
      ├── MessageList.tsx         # 채팅방 목록 컴포넌트
      ├── MessageListItem.tsx     # 채팅방 아이템
      ├── MessageFilters.tsx      # 필터 컴포넌트
      └── UnreadBadge.tsx        # 안읽은 메시지 배지

  6.2 재사용 컴포넌트

  - ChatPanel: 기존 컴포넌트 그대로 활용
  - Badge: MUI Badge 컴포넌트
  - Avatar: 사용자 아바타

  7. 성능 최적화

  7.1 쿼리 최적화

  - 인덱스 활용: (reservation_number, created_at, is_read)
  - 페이지네이션: 채팅방 목록 20개씩
  - 메시지는 최근 50개만 초기 로드

  7.2 캐싱 전략

  - React Query 사용
  - 채팅방 목록: 5분 캐시
  - 안읽은 수: Realtime으로만 업데이트
  - 메시지: 무한 스크롤 + 캐시

  8. 추가 기능 (선택사항)

  8.1 알림 기능

  - 브라우저 Push Notification
  - 소리 알림 옵션
  - 데스크톱 알림

  8.2 검색 기능

  - 메시지 내용 검색
  - 보낸 사람 검색
  - 날짜 범위 검색

  8.3 메시지 관리

  - 메시지 삭제
  - 중요 메시지 표시
  - 메시지 내보내기

  9. 구현 우선순위

  Phase 1 (필수)

  1. ✅ MenuItems.ts에 메시지 메뉴 추가
  2. ✅ 메시지 목록 페이지 생성
  3. ✅ 안읽은 메시지 수 표시
  4. ✅ 채팅 상세 페이지

  Phase 2 (권장)

  5. ⏳ 실시간 업데이트
  6. ⏳ 읽음 처리 자동화
  7. ⏳ 필터 기능

  Phase 3 (선택)

  8. ⏸️ 검색 기능
  9. ⏸️ 알림 기능
  10. ⏸️ 메시지 관리

  10. 예상 소요 시간

  - Phase 1: 2-3시간
  - Phase 2: 1-2시간
  - Phase 3: 2-3시간
  - 총 예상: 5-8시간

  11. 테스트 시나리오

  11.1 기능 테스트

  - 메시지 목록 표시
  - 안읽은 메시지 수 정확성
  - 메시지 읽음 처리
  - 실시간 메시지 수신
  - 필터 동작

  11.2 성능 테스트

  - 1000개 이상 메시지 로딩
  - 동시 다발 메시지 처리
  - 메모리 누수 체크

  12. 서비스 타입 매핑

  12.1 서비스 타입과 아이콘

  const serviceTypeConfig = {
    'market-research': {
      icon: '🔍',
      label: '시장조사',
      color: 'primary'
    },
    'factory-contact': {
      icon: '🏭',
      label: '공장컨택',
      color: 'secondary'
    },
    'inspection': {
      icon: '📋',
      label: '검품감사',
      color: 'success'
    },
    'product': {
      icon: '🛍️',
      label: '1688 상품',
      color: 'info'
    },
    'sampling': {
      icon: '📦',
      label: '샘플링',
      color: 'warning'
    },
    'bulk-purchase': {
      icon: '🚛',
      label: '대량구매',
      color: 'error'
    }
  };

  12.2 예약번호 패턴

  - 시장조사: MR-YYYYMMDD-XXXXXX
  - 공장컨택: FC-YYYYMMDD-XXXXXX
  - 검품감사: DL-YYYYMMDD-XXXXXX
  - 1688 상품: PROD-${offerId}
  - 샘플링: SP-YYYYMMDD-XXXXXX
  - 대량구매: BP-YYYYMMDD-XXXXXX

  13. 에러 처리

  13.1 에러 시나리오

  - 네트워크 오류
  - 권한 부족
  - 메시지 전송 실패
  - 번역 실패

  13.2 에러 메시지

  const errorMessages = {
    NETWORK_ERROR: '네트워크 연결을 확인해주세요',
    AUTH_ERROR: '로그인이 필요합니다',
    SEND_FAILED: '메시지 전송에 실패했습니다',
    TRANSLATION_FAILED: '번역 중 오류가 발생했습니다'
  };

  14. 보안 고려사항

  14.1 RLS (Row Level Security)

  - 사용자는 자신이 참여한 채팅만 볼 수 있음
  - sender_id 또는 관련 주문의 user_id 확인

  14.2 데이터 검증

  - XSS 방지: 메시지 내용 sanitize
  - SQL Injection 방지: Prepared statements 사용
  - 파일 업로드 검증: 확장자, 크기 제한