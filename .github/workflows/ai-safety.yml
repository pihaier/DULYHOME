name: AI Safety Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ai-validation:
    name: AI Development Safety Checks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nextjs_flexy

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ./nextjs_flexy/package-lock.json

    - name: Install dependencies
      run: npm ci

    # 1. ë¯¸ì‚¬ìš© imports/exports ê°ì§€
    - name: Check for unused imports and exports
      run: |
        echo "ðŸ” Checking for unused imports..."
        npx ts-prune --error 2>/dev/null || {
          echo "âš ï¸ Note: Some unused exports may be entry points (pages, API routes)"
          true
        }

    # 2. TODO/FIXME ì½”ë©˜íŠ¸ ì²´í¬
    - name: Check for TODO/FIXME comments
      run: |
        echo "ðŸ” Checking for incomplete code (TODO/FIXME)..."
        TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX\|HACK" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" || echo "")
        if [ ! -z "$TODO_COUNT" ]; then
          echo "âš ï¸ Found TODO/FIXME comments:"
          echo "$TODO_COUNT"
          echo "Please complete or document these items before production."
        else
          echo "âœ… No TODO/FIXME comments found."
        fi

    # 3. í™˜ê²½ë³€ìˆ˜ ê²€ì¦
    - name: Validate environment variables
      run: |
        echo "ðŸ” Checking required environment variables..."
        
        # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ëª©ë¡
        REQUIRED_VARS=(
          "NEXT_PUBLIC_SUPABASE_URL"
          "NEXT_PUBLIC_SUPABASE_ANON_KEY"
        )
        
        MISSING_VARS=()
        
        # .env.example íŒŒì¼ ì²´í¬
        if [ ! -f ".env.example" ]; then
          echo "âš ï¸ .env.example file not found. Creating template..."
          cat > .env.example << EOF
        # Supabase
        NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
        NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
        SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
        
        # OpenAI
        OPENAI_API_KEY=your_openai_api_key
        EOF
        fi
        
        echo "âœ… Environment variables check completed."

    # 4. Import ê²½ë¡œ ê²€ì¦
    - name: Check import paths
      run: |
        echo "ðŸ” Checking for broken import paths..."
        
        # TypeScriptê°€ ì´ë¯¸ ì²´í¬í•˜ì§€ë§Œ ì¶”ê°€ ê²€ì¦
        npm run type-check || {
          echo "âŒ Import path errors detected. Please fix them."
          exit 1
        }
        
        echo "âœ… All import paths are valid."

    # 5. íŒŒì¼ í¬ê¸° ì²´í¬ (ëŒ€ìš©ëŸ‰ íŒŒì¼ ë°©ì§€)
    - name: Check for large files
      run: |
        echo "ðŸ” Checking for large files..."
        
        LARGE_FILES=$(find src/ public/ -type f -size +1M 2>/dev/null || true)
        if [ ! -z "$LARGE_FILES" ]; then
          echo "âš ï¸ Large files detected (>1MB):"
          echo "$LARGE_FILES"
          echo "Consider optimizing images or moving large assets to CDN."
        else
          echo "âœ… No large files found."
        fi

    # 6. ì¤‘ë³µ ì½”ë“œ ê°ì§€
    - name: Check for code duplication
      run: |
        echo "ðŸ” Checking for duplicate code patterns..."
        
        # jscpd ì„¤ì¹˜ ë° ì‹¤í–‰ (ì¤‘ë³µ ì½”ë“œ ê°ì§€)
        npx jscpd src/ \
          --min-lines 10 \
          --min-tokens 50 \
          --threshold 5 \
          --reporters "consoleFull" \
          --ignore "**/*.test.*,**/*.spec.*" \
          --silent || {
          echo "âš ï¸ Some code duplication detected. Consider refactoring."
          true
        }

    # 7. ë³´ì•ˆ íŒ¨í„´ ê²€ì‚¬
    - name: Security patterns check
      run: |
        echo "ðŸ” Checking for security issues..."
        
        # SQL Injection íŒ¨í„´ ì²´í¬
        if grep -r "query.*\${.*}" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
          echo "âš ï¸ Potential SQL injection pattern found. Use parameterized queries."
        fi
        
        # í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì²´í¬
        if grep -r -E "(api[_-]?key|secret|password|token)\s*=\s*['\"][^'\"]*['\"]" src/ \
           --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" 2>/dev/null | \
           grep -v -E "(process\.env|import|require|interface|type|:\s*string)"; then
          echo "âŒ Potential hardcoded secrets found. Use environment variables."
          exit 1
        else
          echo "âœ… No hardcoded secrets detected."
        fi

    # 8. íŒ¨í‚¤ì§€ ì·¨ì•½ì  ìŠ¤ìº”
    - name: Security audit
      run: |
        echo "ðŸ” Running security audit..."
        npm audit --audit-level=high || {
          echo "âš ï¸ Security vulnerabilities found. Run 'npm audit fix' to resolve."
          true
        }

    # 9. Prettier í¬ë§· ì²´í¬
    - name: Check code formatting
      run: |
        echo "ðŸ” Checking code formatting..."
        npx prettier --check "src/**/*.{js,jsx,ts,tsx,css,scss,md}" || {
          echo "âŒ Code formatting issues found. Run 'npm run format' to fix."
          exit 1
        }

    # 10. ë¹Œë“œ ì‚°ì¶œë¬¼ í¬ê¸° ì²´í¬
    - name: Check bundle size
      if: success()
      run: |
        echo "ðŸ“¦ Checking bundle size..."
        npm run build
        
        # .next í´ë” í¬ê¸° ì²´í¬
        BUNDLE_SIZE=$(du -sh .next | cut -f1)
        echo "Bundle size: $BUNDLE_SIZE"
        
        # í¬ê¸°ê°€ ë„ˆë¬´ í¬ë©´ ê²½ê³ 
        SIZE_MB=$(du -sm .next | cut -f1)
        if [ $SIZE_MB -gt 50 ]; then
          echo "âš ï¸ Bundle size is large (>50MB). Consider code splitting or lazy loading."
        else
          echo "âœ… Bundle size is acceptable."
        fi
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ vars.SUPABASE_URL || 'https://example.supabase.co' }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.SUPABASE_ANON_KEY || 'example-key' }}

    # ìµœì¢… ìš”ì•½
    - name: Summary
      if: always()
      run: |
        echo "========================================="
        echo "ðŸ¤– AI Safety Checks Complete"
        echo "========================================="
        echo "These checks help prevent common AI coding mistakes:"
        echo "âœ“ Console.log statements"
        echo "âœ“ Unused imports"
        echo "âœ“ TODO/FIXME comments"
        echo "âœ“ Import path validity"
        echo "âœ“ Security patterns"
        echo "âœ“ Code formatting"
        echo "âœ“ Bundle size"
        echo "========================================="