name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

jobs:
  # PR ì œëª© ë° ì„¤ëª… ê²€ì¦
  pr-validation:
    name: Validate PR
    runs-on: ubuntu-latest

    steps:
    - name: Check PR title format
      uses: actions/github-script@v7
      with:
        script: |
          const title = context.payload.pull_request.title;
          const validPrefixes = ['feat:', 'fix:', 'docs:', 'style:', 'refactor:', 'test:', 'chore:'];
          
          const isValidTitle = validPrefixes.some(prefix => title.startsWith(prefix));
          
          if (!isValidTitle) {
            core.setFailed(`PR ì œëª©ì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œ ì‹œì‘í•´ì•¼ í•©ë‹ˆë‹¤: ${validPrefixes.join(', ')}`);
          }

    - name: Check PR description
      uses: actions/github-script@v7
      with:
        script: |
          const body = context.payload.pull_request.body;
          
          if (!body || body.length < 20) {
            core.setFailed('PR ì„¤ëª…ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 20ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.');
          }

  # íŒŒì¼ ë³€ê²½ ë¶„ì„
  changed-files:
    name: Analyze Changed Files
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files_yaml: |
          frontend:
            - 'nextjs/src/**/*.{js,jsx,ts,tsx}'
            - 'nextjs/src/**/*.{css,scss}'
          backend:
            - 'nextjs/src/app/api/**/*.ts'
            - 'nextjs/src/lib/**/*.ts'
          database:
            - 'supabase/migrations/**/*.sql'
            - 'supabase/functions/**/*.ts'
          config:
            - 'nextjs/package*.json'
            - 'nextjs/tsconfig.json'
            - 'nextjs/next.config.js'
            - '.github/workflows/**/*.yml'

    - name: Show changed file categories
      run: |
        echo "ğŸ“ Changed file categories:"
        if [ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]; then
          echo "ğŸ¨ Frontend files changed"
          echo "Files: ${{ steps.changed-files.outputs.frontend_all_changed_files }}"
        fi
        if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]; then
          echo "âš™ï¸ Backend files changed"
          echo "Files: ${{ steps.changed-files.outputs.backend_all_changed_files }}"
        fi
        if [ "${{ steps.changed-files.outputs.database_any_changed }}" == "true" ]; then
          echo "ğŸ—„ï¸ Database files changed"
          echo "Files: ${{ steps.changed-files.outputs.database_all_changed_files }}"
        fi
        if [ "${{ steps.changed-files.outputs.config_any_changed }}" == "true" ]; then
          echo "âš™ï¸ Configuration files changed"
          echo "Files: ${{ steps.changed-files.outputs.config_all_changed_files }}"
        fi

  # Frontend ë³€ê²½ ì‹œ ì¶”ê°€ ê²€ì‚¬
  frontend-checks:
    name: Frontend Specific Checks
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.frontend_any_changed == 'true'
    defaults:
      run:
        working-directory: ./nextjs

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ./nextjs/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check for console.log statements
      run: |
        if grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx"; then
          echo "âŒ console.log statements found. Please remove them before merging."
          exit 1
        else
          echo "âœ… No console.log statements found."
        fi

    - name: Check bundle size
      run: |
        npm run build
        npm run analyze
        echo "ğŸ“¦ Build completed. Check bundle size in the build output."

  # Database ë³€ê²½ ì‹œ ì¶”ê°€ ê²€ì‚¬
  database-checks:
    name: Database Migration Checks
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.database_any_changed == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Validate SQL migrations
      run: |
        cd supabase
        for file in migrations/*.sql; do
          if [ -f "$file" ]; then
            echo "ğŸ” Validating $file"
            # SQL êµ¬ë¬¸ ê²€ì‚¬ (ê¸°ë³¸ì ì¸ ì²´í¬)
            if ! grep -q "^--" "$file"; then
              echo "âš ï¸ Migration file $file should start with a comment describing the change"
            fi
          fi
        done

    - name: Check for dangerous operations
      run: |
        cd supabase/migrations
        dangerous_operations=("DROP TABLE" "DROP COLUMN" "ALTER TABLE.*DROP" "TRUNCATE")
        
        for file in *.sql; do
          if [ -f "$file" ]; then
            for op in "${dangerous_operations[@]}"; do
              if grep -iq "$op" "$file"; then
                echo "âš ï¸ Dangerous operation '$op' found in $file"
                echo "Please review carefully and add appropriate safeguards."
              fi
            done
          fi
        done

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nextjs

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ./nextjs/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Check for hardcoded secrets
      run: |
        echo "ğŸ” Checking for potential hardcoded secrets..."
        if grep -r -i "password\s*=\s*['\"]" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" || \
           grep -r -i "api_key\s*=\s*['\"]" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" || \
           grep -r -i "secret\s*=\s*['\"]" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx"; then
          echo "âŒ Potential hardcoded secrets found. Please review and use environment variables."
          exit 1
        else
          echo "âœ… No obvious hardcoded secrets found."
        fi

    - name: Audit dependencies
      run: npm audit --audit-level=moderate

  # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì½”ë©˜íŠ¸
  coverage-comment:
    name: Coverage Comment
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nextjs

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ./nextjs/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run tests with coverage
      run: npm run test:coverage

    - name: Coverage comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const coveragePath = path.join('./nextjs/coverage/coverage-summary.json');
            if (fs.existsSync(coveragePath)) {
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
              const total = coverage.total;
              
              const comment = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë³´ê³ ì„œ
              
              | í•­ëª© | ì»¤ë²„ë¦¬ì§€ | 
              |------|----------|
              | ë¼ì¸ | ${total.lines.pct}% |
              | í•¨ìˆ˜ | ${total.functions.pct}% |
              | ë¸Œëœì¹˜ | ${total.branches.pct}% |
              | ë¬¸ì¥ | ${total.statements.pct}% |
              
              ${total.lines.pct >= 70 ? 'âœ…' : 'âŒ'} ë¼ì¸ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ: 70%
              ${total.functions.pct >= 70 ? 'âœ…' : 'âŒ'} í•¨ìˆ˜ ì»¤ë²„ë¦¬ì§€ ëª©í‘œ: 70%
              `;
              
              // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub API ì‚¬ìš©)
              console.log(comment);
            }
          } catch (error) {
            console.log('Coverage report not available');
          }