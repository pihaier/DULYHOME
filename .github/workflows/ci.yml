name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ë¹Œë“œ ë° íƒ€ì… ì²´í¬
  build:
    name: Build and Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nextjs_flexy

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: ./nextjs_flexy/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: TypeScript type check
      run: npm run type-check

    - name: Run ESLint
      run: npm run lint
      # AI ê°œë°œ í™˜ê²½: ë¦°íŠ¸ ì—ëŸ¬ ì‹œ ë°°í¬ ì°¨ë‹¨

    - name: Check for console.log statements
      run: |
        echo "ğŸ” Checking for console.log statements..."
        if grep -r "console\.log" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --exclude-dir=node_modules; then
          echo "âš ï¸ Warning: console.log found in production code. Consider removing them."
          echo "This is currently a warning. Will become an error in the future."
        else
          echo "âœ… No console.log statements found."
        fi

    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || vars.SUPABASE_URL }}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || vars.SUPABASE_ANON_KEY }}
        SUPABASE_URL: ${{ vars.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ vars.SUPABASE_ANON_KEY }}

  # Vercel ìë™ ë°°í¬ëŠ” Vercel GitHub Integrationì´ ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì œê±°
  # Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ë„ Supabase GitHub Integrationì´ ì²˜ë¦¬

  # ë°°í¬ í›„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
  smoke-test:
    name: Post-Deploy Smoke Tests
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for Vercel deployment
      run: sleep 60  # Vercel ë°°í¬ ì™„ë£Œ ëŒ€ê¸°
      
    - name: Health Check
      run: |
        echo "ğŸ” Running smoke tests..."
        
        # í”„ë¡œë•ì…˜ URL (í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì • ê°€ëŠ¥)
        # Vercel í”„ë¡œì íŠ¸ëª…ì´ ë³€ê²½ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™˜ê²½ë³€ìˆ˜ ì‚¬ìš© ê¶Œì¥
        URL="${{ vars.PRODUCTION_URL || 'https://dulyhome.vercel.app' }}"
        
        echo "Testing URL: $URL"
        
        # 1. í™ˆí˜ì´ì§€ ì²´í¬
        echo "Checking homepage..."
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" $URL)
        if [ $STATUS -eq 200 ]; then
          echo "âœ… Homepage: OK ($STATUS)"
        elif [ $STATUS -eq 404 ]; then
          echo "âš ï¸ Homepage: URL not found (HTTP $STATUS) - Check PRODUCTION_URL variable"
          echo "Skipping further tests..."
          exit 0  # ì¼ì‹œì ìœ¼ë¡œ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
        else
          echo "âŒ Homepage: Failed (HTTP $STATUS)"
          exit 1
        fi
        
        # 2. Health API ì²´í¬
        echo "Checking health API..."
        HEALTH=$(curl -s "$URL/api/health")
        if echo $HEALTH | grep -q '"status":"healthy"'; then
          echo "âœ… Health API: OK"
        else
          echo "âš ï¸ Health API: Degraded"
          echo "$HEALTH"
        fi
        
        # 3. ì£¼ìš” í˜ì´ì§€ ì²´í¬
        PAGES=("/dashboard" "/auth/customer/login" "/application/inspection")
        for PAGE in "${PAGES[@]}"; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL$PAGE")
          if [ $STATUS -eq 200 ] || [ $STATUS -eq 307 ] || [ $STATUS -eq 308 ]; then
            echo "âœ… $PAGE: OK ($STATUS)"
          else
            echo "âš ï¸ $PAGE: Warning (HTTP $STATUS)"
          fi
        done
        
        echo "âœ… Smoke tests completed"