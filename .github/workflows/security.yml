name: Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ì‹œí¬ë¦¿ ìŠ¤ìº”
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ ê²€ì‚¬

    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITLEAKS_ENABLE_SUMMARY: true

  # í™˜ê²½ë³€ìˆ˜ ê²€ì¦
  env-validation:
    name: Environment Variables Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Required Environment Variables
      run: |
        echo "ğŸ” Checking required environment variables..."
        
        # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ëª©ë¡
        REQUIRED_VARS=(
          "NEXT_PUBLIC_SUPABASE_URL"
          "NEXT_PUBLIC_SUPABASE_ANON_KEY"
          "SUPABASE_SERVICE_ROLE_KEY"
          "OPENAI_API_KEY"
          "EMAIL_SERVICE_API_KEY"
        )
        
        MISSING_VARS=()
        
        # GitHub Secrets/Variables ì²´í¬
        for var in "${REQUIRED_VARS[@]}"; do
          # Check if var exists in secrets or variables
          if [[ -z "${{ secrets[var] }}" ]] && [[ -z "${{ vars[var] }}" ]]; then
            if [[ "$var" != "OPENAI_API_KEY" ]] && [[ "$var" != "EMAIL_SERVICE_API_KEY" ]]; then
              # Non-critical vars are warnings
              echo "âš ï¸ Warning: $var is not configured"
            else
              # Critical vars cause failure
              MISSING_VARS+=("$var")
              echo "âŒ Critical: $var is missing!"
            fi
          else
            echo "âœ… $var is configured"
          fi
        done
        
        if [ ${#MISSING_VARS[@]} -gt 0 ]; then
          echo "âŒ Missing critical environment variables: ${MISSING_VARS[*]}"
          echo "Please configure these in GitHub Secrets or Variables"
          exit 1
        fi
        
        echo "âœ… All critical environment variables are configured"

  # Supabase RLS ê²€ì¦ (í”„ë¡œë•ì…˜ ë°°í¬ ì‹œ)
  rls-check:
    name: Database Security Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Supabase CLI
      uses: supabase/setup-cli@v1
      with:
        version: latest

    - name: Check RLS Policies
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ vars.SUPABASE_PROJECT_ID }}
      run: |
        echo "ğŸ” Checking Row Level Security policies..."
        
        # Supabase í”„ë¡œì íŠ¸ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
        if [ -z "$SUPABASE_PROJECT_ID" ]; then
          echo "âš ï¸ Supabase project not configured. Skipping RLS check."
          exit 0
        fi
        
        # RLS ì²´í¬ (ì‹¤ì œ êµ¬í˜„ ì‹œ supabase CLI ëª…ë ¹ì–´ ì‚¬ìš©)
        echo "âœ… RLS check placeholder - implement with actual Supabase CLI commands"
        
        # ì˜ˆì‹œ:
        # supabase db lint --linked
        # supabase inspect db --linked | grep "RLS disabled" && exit 1